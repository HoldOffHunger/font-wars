/* Font Wars 
Copyright 2011, Oran Looney

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.
*/

$(function() { 
var words = 'a,able,about,above,across,act,action,actually,add,addition,adjective,afraid,Africa,after,again,against,age,ago,agreed,ahead,air,all,allow,almost,alone,along,already,also,although,always,am,America,among,amount,an,and,angle,animal,another,answer,any,anything,appear,apple,are,area,arms,army,around,arrived,art,as,ask,at,away,baby,back,bad,ball,bank,base,be,bear,beat,beautiful,became,because,become,bed,been,before,began,begin,behind,being,believe,bell,belong,below,beside,best,better,between,big,bill,birds,bit,black,block,blood,blow,blue,board,boat,body,bones,book,born,both,bottom,box,boy,branches,break,bright,bring,British,broken,brother,brought,brought,brown,build,building,built,burning,business,but,buy,by,call,came,can,cannot,can\'t,capital,captain,car,care,carefully,carry,case,cat,catch,cattle,caught,cause,cells,center,cents,century,certain,chance,change,chart,check,chief,child,children,choose,church,circle,city,class,clean,clear,climbed,close,clothes,cloud,coast,cold,color,column,come,common,company,compare,complete,compound,conditions,consider,consonant,contain,continued,control,cook,cool,copy,corn,corner,correct,cost,cotton,could,couldn\'t,count,country,course,covered,cows,create,cried,crops,cross,crowd,current,cut,dance,dark,day,dead,deal,death,decided,decimal,deep,describe,desert,design,details,determine,developed,dictionary,did,didn\'t,died,difference,different,difficult,direct,direction,discovered,distance,divided,division,do,doctor,does,doesn\'t,dog,dollars,done,don\'t,door,down,draw,drawing,dress,drive,drop,dry,during,each,early,ears,earth,east,easy,eat,edge,effect,eggs,eight,either,electric,elements,else,end,energy,engine,England,English,enjoy,enough,entered,entire,equal,equation,especially,Europe,even,evening,ever,every,everyone,everything,exactly,example,except,exciting,exercise,expect,experience,experiment,explain,express,eye,face,fact,factories,factors,fall,family,famous,far,farm,farmers,fast,father,fear,feel,feeling,feet,fell,felt,few,field,fig,fight,figure,filled,finally,find,fine,fingers,finished,fire,first,fish,fit,five,flat,floor,flow,flowers,fly,follow,food,foot,for,force,forest,form,forward,found,four,fraction,France,free,French,fresh,friends,from,front,fruit,full,fun,game,garden,gas,gave,general,get,girl,give,glass,go,God,gold,gone,good,got,government,grass,great,Greek,green,grew,ground,group,grow,guess,gun,had,hair,halt,hand,happened,happy,hard,has,hat,have,he,head,hear,heard,heart,heat,heavy,held,help,her,here,high,hill,him,himself,his,history,hit,hold,hole,home,hope,horse,hot,hours,house,how,however,huge,human,hundred,hunting,I,ice,idea,if,I\'ll,important,in,inches,include,increase,Indian,indicate,industry,information,insects,inside,instead,instruments,interest,interest,into,iron,is,island,isn\'t,it,its,it\'s,itself,Japanese,job,joined,jumped,just,keep,kept,key,killed,kind,king,knew,know,known,lady,lake,land,language,large,last,later,laughed,law,lay,lead,learn,least,leave,led,left,legs,length,less,let,let\'s,letter,level,lie,life,lifted,light,like,line,list,listen,little,live,located,long,look,lost,lot,loud,love,low,machine,made,main,major,make,man,many,map,march,mark,match,material,matter,may,maybe,me,mean,measure,meat,meet,melody,members,men,metal,method,middle,might,mile,milk,million,mind,mine,minutes,miss,modern,molecules,moment,money,months,moon,more,morning,most,mother,mountain,mouth,move,movement,much,music,must,my,name,nation,natural,near,necessary,need,never,new,next,night,no,nor,north,northern,nose,not,note,nothing,notice,noun,now,number,numeral,object,observe,ocean,of,off,office,often,oh,oil,old,on,once,one,only,open,opposite,or,order,other,our,out,outside,over,own,oxygen,page,paint,pair,paper,paragraph,park,part,particular,party,passed,past,pattern,pay,people,per,perhaps,period,person,phrase,picked,picture,piece,place,plains,plan,plane,plant,plants,play,please,plural,poem,point,pole,poor,position,possible,pounds,power,practice,prepared,presidents,pretty,printed,probably,problem,process,produce,products,property,provide,pulled,pushed,put,questions,quickly,quiet,quite,race,radio,rain,raised,ran,rather,reached,read,ready,really,reason,received,record,red,region,remain,remember,repeated,report,represent,resent,rest,result,return,rhythm,rich,ride,right,ring,rise,river,road,rock,rolled,room,root,rope,rose,round,row,rule,run,safe,said,sail,same,sand,sat,save,saw,say,scale,school,science,scientists,score,sea,seat,second,section,see,seeds,seem,seen,sell,send,sense,sent,sentence,separate,serve,set,settled,seven,several,shall,shape,sharp,she,ship,shoes,shop,short,should,shoulder,shouted,show,shown,side,sight,sign,signal,silent,similar,simple,since,sing,sir,sister,sit,six,size,skin,sky,sleep,sleep,slowly,small,smell,smiled,snow,so,soft,soil,soldiers,solution,some,someone,something,sometimes,son,song,soon,sound,south,southern,space,speak,special,speed,spell,spot,spread,spring,square,stand,stars,start,state,statement,stay,steel,step,stick,still,stone,stood,stop,store,story,straight,strange,stream,street,stretched,string,strong,students,study,subject,substances,such,suddenly,suffix,sugar,suggested,sum,summer,sun,supply,suppose,sure,surface,surprise,swim,syllables,symbols,system,table,tail,take,talk,tall,teacher,team,tell,temperature,ten,terms,test,than,that,the,their,them,themselves,then,there,these,they,thick,thin,thing,think,third,this,those,though,thought,thousands,three,through,thus,tied,time,tiny,to,today,together,told,tone,too,took,tools,top,total,touch,toward,town,track,trade,train,train,travel,tree,triangle,trip,trouble,truck,true,try,tube,turn,two,type,uncle,under,underline,understand,unit,until,up,upon,us,use,usually,valley,value,various,verb,very,view,village,visit,voice,vowel,wait,walk,wall,want,war,warm,was,wash,Washington,wasn\'t,watch,water,waves,way,we,wear,weather,week,weight,well,we\'ll,went,were,west,western,what,wheels,when,where,whether,which,while,white,who,whole,whose,why,wide,wife,wild,will,win,wind,window,wings,winter,wire,wish,with,within,without,woman,women,wonder,won\'t,wood,word,work,workers,world,would,wouldn\'t,write,written,wrong,wrote,yard,year,yellow,yes,yet,you,young,your,you\'re,yourself'.split(',');

var loadingScreen = true;
var gameOver = false;
var points = 0;
var multiplier = 1;
var hits = 0;
var misses = 0;
var startTime = new Date();

var bullets = ['.', '!', '*', '..', '!!', '**'];
function setMultiplier(m) {
	multiplier = m || 1;
	if ( multiplier > 50 ) multiplier = 50;

	if ( multiplier == 50 ) bullet = bullets[5];
	else if ( multiplier >= 30 ) bullet = bullets[4];
	else if ( multiplier >= 20 ) bullet = bullets[3];
	else if ( multiplier >= 10 ) bullet = bullets[2];
	else if ( multiplier >= 5 ) bullet = bullets[1];
	else bullet = bullets[0];
}
setMultiplier(1);

sound.fx.load('hit.', 'resources/sounds/39459__THE_bizniss__laser.ogg', 1.0, 7);
sound.fx.load('hit!', 'resources/sounds/39456__THE_bizniss__laser_2.ogg', 1.0, 7);
sound.fx.load('hit*', 'resources/sounds/39458__THE_bizniss__laser_4.ogg', 1.0, 7);
sound.fx.load('miss','resources/sounds/2225__Andrew_Duke__garp.ogg', 0.5);
sound.fx.load('kill', 'resources/sounds/91924__Benboncan__Till_With_Bell.ogg');
sound.fx.load('die', 'resources/sounds/33245__ljudman__grenade.ogg');

sound.music.load('fast', 'resources/sounds/Speed_Kills_1.ogg');
sound.music.load('ending', 'resources/sounds/erase-it.ogg');

function log(message) {
	$('body').append( message + '<br>');
}

$.fn.startsWith = function(letter) {
	return this.filter(function() {
		return ( $(this).html().charAt(0).toLowerCase() === letter );
	});
}

// take the single lowest element closest to another
$.fn.nearest = function(target) { 
	var minD = Infinity, nearestEl;
	this.each(function() {
		var d = distance(this, target);
		if ( d < minD ) {
			minD = d;
			nearestEl = this;
		}
	});
	return $(nearestEl);
}

// rotate an element to point at another
$.fn.pointAt = function(target) { 
	target = pos(target);
	$(this).each(function() {
		var p = $(this).position();
		var dx = target.left - p.left;
		var dy = p['top'] - target['top'];
		var angle = Math.atan(dy/dx);
		if ( dx < 0 ) angle += Math.PI;
		// that's the angle in the usual coordinates... but rotate
		// specifies a clockwise rotation starting 90 degrees off.
		rotateAngle = -(angle - Math.PI/2);

		var rotate = 'rotate(' + (rotateAngle * 180/Math.PI) + 'deg)';
		$(this).css({ 
			'-webkit-transform': rotate,
			'-moz-transform': rotate,
			'transform': rotate 
		});
	});
	return this;
}

$.fn.center = function () {
    this.css("position","absolute");
    this.css("top", ( $(window).height() - this.height() ) / 2+$(window).scrollTop() + "px");
    this.css("left", ( $(window).width() - this.width() ) / 2+$(window).scrollLeft() + "px");
    return this;
}

Array.prototype.random = function() {
	return this[ Math.floor(Math.random() * this.length) ]
}

function newSprite(cls, content) { 
	var sprite = document.createElement('div');
	sprite.innerHTML = content;
	sprite.className = 'sprite ' + cls;
	$('body').append(sprite);
	return sprite;
}

var spaceship = newSprite('spaceship', 'A');
$(spaceship).center().hide();

var instructions = newSprite('instructions', [
	'<h1>Font Wars</h1>',
	'Type the words as they appear',
	'Once you start a word you must finish it',
	'The currently targeted word is underlined',
	'The game is over when they reach you',
	'',
	'Press Enter to begin'
].join('<br>'));
$(instructions).center();

var score = newSprite('score', '');
$(score).css({ opacity: 0.7 });

var mute = newSprite('mute', 'Mute');
$(mute).css({ opacity: 0.7 }).click(function() {
	if ( $(mute).html() === 'Mute' ) {
		sound.mute();
		$(mute).html('Unmute');
	} else {
		sound.unmute();
		$(mute).html('Mute');
	}
});

function updateScore() {
	var minutes = (new Date() - startTime) / 6e4;
	if ( minutes < 0.1 ) { 
		var wpm = 0;
	} else {
		var words = hits / 5;
		var wpm = Math.floor(words/minutes);
	}

	if ( hits == 0 ) {
		var accuracy = 0;
	} else {
		var accuracy = Math.floor(100 * hits / (hits + misses));
	}
	

	var x = ' ' + multiplier + 'x';
	if ( gameOver ) {
		x = '';
		var seconds = Math.floor((new Date() - startTime)/1000);
		var minutes = Math.floor(seconds/60);
		var seconds = seconds - minutes * 60;
		var duration = minutes + ' minutes ' + seconds + ' seconds';
		var highScoreMessage = handleHighScore();
		$(score).html('<b>' + points + ' Points</b><br>' + highScoreMessage + wpm + ' WPM<br>' + accuracy + '% Accuracy<br>' + duration);
	} else {
		$(score).html(points + ' Points<br>' + multiplier + 'x Multiplier<br>' + wpm + ' WPM<br>' + accuracy + '% Accuracy');
	}
}
updateScore();

function handleHighScore() {
	var message = '';
	var previousHighScore = $.cookie('font-wars-high-score') || 0;
	if ( points > previousHighScore ) {
		$.cookie('font-wars-high-score', points, { duration: 999, path: '/' });
		message = '<b>New High Score!</b><br>';
	} else if ( previousHighScore > 0 ) {
		message = 'Previous Best: ' + previousHighScore + '<br>';
	}
	return message;
}


function pos(any) {
	if ( !any['top'] || !any['left'] ) return $(any).position();
	else return any;
}
function distance(a,b) {
	a = pos(a);
	b = pos(b);
	var dx = (a.left - b.left);
	var dy = (a['top'] - b['top']);
	return Math.sqrt( dx*dx + dy*dy );
}

function attackingWordCount() {
	var chars = 0;
	$('.enemy').each(function() {
		chars += $(this).html().replace(/[^a-zA-Z']/g, '').length;
	});
	return Math.floor(chars/5);
}

function spawn() {
	if ( gameOver ) return;

	// ambiguous starting letters are annoying.  Even though we automatically target
	// the nearest word, it can still suprise the player sometimes.  This second-guess
	// logic reduces but doesn't eliminate this situation without messing up the distribution too much.
	var word = words.random();
	if ( $('.enemy').startsWith(word.charAt(0)).length ) word = words.random();
	if ( $('.enemy').startsWith(word.charAt(0)).length ) word = words.random();
	
	var enemy = newSprite('enemy', word);
	var side = Math.floor(Math.random() * 4);
	if ( side == 0 ) { // top
		$(enemy).css({ "top": -32, left: Math.random() * $(window).width() });
	} else if ( side == 1 ) { // right
		$(enemy).css({ "left": $(window).width()+32, top: Math.random() * $(window).height() });
	} else if ( side == 2 ) { // bottom
		$(enemy).css({ "top": $(window).height() + 32, left: Math.random() * $(window).width() });
	} else { // left
		$(enemy).css({ "left": -32, top: Math.random() * $(window).height() });
	}

	// auto-balancing logic
	var danger = attackingWordCount();
	$(enemy).animate( $(spaceship).position(), 10000 + 1000*danger - 15*hits, 'linear', function() {
		// the player dies when an enemy reaches the spaceship.
		// the timeout is because we can't start the fade animation on this enemy from inside this callback.
		if ( $.contains(document.body, this) ) setTimeout(function() { die(); }, 1);
	});
	var spawnInterval = 200 + 400*danger - 5*hits + 100 - 200*Math.random();
	if ( spawnInterval < 1 ) spawnInterval = 1;
	setTimeout(spawn, spawnInterval);
}

function die() {
	sound.music.volume(0, 500);
	sound.fx.play('die');
	gameOver = true;

	updateScore();

	$('.enemy').stop();
	$('.enemy').animate({opacity: 'hide'}, 1000, 'linear', function() { $(this).remove(); });
	$(spaceship).animate({opacity: 0}, 2000, 'linear', function() {
		setTimeout(function() { 
			sound.music.play('ending', 1.0, 700);
			$(newSprite('game-over', 'Game Over'))
				.css({ fontSize: '64px', width: '10em', opacity: 0 })
				.center()
				.animate({ opacity: 1.0 }, 4000, undefined, function() {
					$(score).css($(score).position()).animate({
						opacity: 1.0,
						"top": 80 + ( $(window).height() - $(score).height() ) / 2 + $(window).scrollTop() + "px",
						left: ( $(window).width() - $(score).width() ) / 2 + $(window).scrollLeft() + "px",
					}, 1500);
				});
		}, 500);
	});
}

// target an enemy...
$.fn.target = function() {
	this.addClass('target');
	this.siblings('.enemy').removeClass('target');
	$(spaceship).pointAt(this);
	return this;
}

// hit an enemy...
$.fn.hit = function() {
	hits++;
	points += multiplier;
	sound.fx.play('hit' + bullet.charAt(0));
	$(newSprite('bullet', bullet))
		.css( $('.spaceship').position() )
		.pointAt(this)
		.animate( this.position(), distance(spaceship, this)/3, 'linear', function() { 
			$(this).remove();}
		);
	var newWord = this.html().slice(1);
	if ( newWord.length === 0 ) {
		sound.fx.play('kill');
		setMultiplier(multiplier+1);
		this.remove();
	} else {
		if ( !this.hasClass('target') ) this.target();
		this.html(newWord);
	}
	return this;
}

// oops, a bad character
function miss(letter) { 
	misses++;
	setMultiplier(1);
	sound.fx.play('miss');
}

$(document).keypress(function(e) {
	if ( gameOver ) return;

	if ( loadingScreen ) {
		if ( e.which === 13 ) {
			startTime = new Date();
			loadingScreen = false;
			$(spaceship).show();
			$(instructions).fadeOut(500);
			spawn();
			sound.music.loop('fast', 1.0, 10);
		}
	}

	// ignore all shortcuts
	if ( e.altKey || e.ctrlKey ) return;
	var key = e.which;
	var letter = '';
	if ( key > 96 && key < 123 ) letter = String.fromCharCode(key);
	else if ( key > 64 && key < 91 ) letter = String.fromCharCode(key + 32);
	else if ( key === 39 || key === 34 ) letter = "'"; // apostrophes are used in some words...
	else return;

	var target = $('.enemy.target').first();
	if ( target.length ) {
		if ( target.startsWith(letter).length ) target.hit();
		else miss(letter);
	} else {
		var target = $('.enemy').startsWith(letter).nearest(spaceship);
		if ( target.length ) target.hit();
		else miss(letter);
	}
	updateScore();
});

});
